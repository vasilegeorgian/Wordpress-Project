(($,u)=>{'use strict';let n;window.ThemifyBuilderPage={container:null,layout_lists:null,spinner:null,layouts_loaded:!1,loadCSS(){const l=u.createDocumentFragment();Object.keys(tbBuilderPage.css).forEach(function(e){if(!document.getElementById(e+'-css')){const t=u.createElement('link');t.setAttribute('rel','stylesheet'),t.setAttribute('href',tbBuilderPage.css[e]),t.setAttribute('id',e+'-css'),l.appendChild(t)}}),u.head.appendChild(l)},loadLayoutsList(){$.ajax({type:'POST',url:tbBuilderPage.ajaxurl,dataType:'json',data:{action:'tb_load_predesigned_layouts',nonce:tbBuilderPage.nonce,src:tbBuilderPage.paths.layouts_index},success(e){n.layouts_loaded=!0;const t=JSON.parse(e.data);n.renderLayouts(t),n.spinner.style.display='none'},error(){}})},publishPage(e){return $.ajax({type:'POST',url:tbBuilderPage.ajaxurl,data:{_ajax_nonce:tbBuilderPage.nonce,action:'tb_builder_page_publish',title:e.title,layout:e.layout,parent:e.parent},success(e){e.success?window.location=e.data:(console&&console.log(e),n.hidePanel())},complete(){n.spinner.style.display='none'}})},renderLayouts(s,e){const r={},o=u.createDocumentFragment(),c=(u.createDocumentFragment(),n.container.querySelector('.tbbp_search_icon svg')),d=n.container.querySelector('.tbbp_category ul');for(let i=0,e=s.length;i<e;++i){let e=u.createElement('li'),t=u.createElement('div'),l=u.createElement('div'),a=u.createElement('div'),n=u.createElement('img');if(e.dataset.category=s[i].category,t.className='tbbp_preview',t.dataset.id=s[i].id,t.dataset.slug=s[i].slug,l.className='tbbp_thumbnail',n.src=s[i].thumbnail,n.alt=s[i].title,n.title=s[i].title,a.className='tbbp_layout_title',a.textContent=s[i].title,l.appendChild(n),t.appendChild(l),t.appendChild(a),void 0!==s[i].url){let e=u.createElement('a');e.className='tbbp_preview_link',e.href=s[i].url,e.target='_blank',e.title='Preview',e.appendChild(c.cloneNode(!0)),t.appendChild(e)}if(e.appendChild(t),o.appendChild(e),s[i].category){let l=String(s[i].category).split(',');for(let t=0,e=l.length;t<e;++t)if(''!==l[t]&&1!==r[l[t]]){let e=u.createElement('li');e.textContent=l[t],d.appendChild(e),r[l[t]]=1}}}n.layout_lists.appendChild(o)},init(){n.layout_lists.addEventListener('click',function(e){if(e.target.closest('li')){const t=n.layout_lists.querySelector('.selected');t&&t.classList.remove('selected'),e.target.closest('li').classList.add('selected')}}),n.container.querySelector('.tbbp_close').addEventListener('click',function(){n.hidePanel()}),n.container.querySelector('.tbbp_search_container input').addEventListener('keyup',function(){let e=this.value.trim(),t=$(n.layout_lists).find('li');(''===e?t:t.hide().find('.tbbp_layout_title').filter(function(){return new RegExp(e,"i").test($(this).text())}).closest('li')).show()}),n.container.addEventListener('submit',function(e){const l=n.container.querySelector('.tbbp_title input').value;if(''!==l){e.preventDefault(),n.spinner.style.display='block';const t=n.layout_lists.querySelector('.selected > div').dataset.slug,a=n.container.querySelector('.tbbp_parent select').value;''===t?n.publishPage({title:l,parent:a}):$.get(tbBuilderPage.paths.layout_template.replace('{SLUG}',t),null,null,'text').done(e=>{let t=JSON.parse(e);n.publishPage({title:l,parent:a,layout:t})})}}),n.container.querySelector('.tbbp_category ul').addEventListener('click',a=>{if('LI'===a.target.tagName){let e=$(n.layout_lists).find('li'),t=a.target.textContent,l=a.target.closest('.tbbp_category').querySelector('.tbbp_category_label');l.blur(),l.textContent=t,(a.target.classList.contains('all')?e:e.hide().filter('[data-category*="'+t+'"]')).show()}})},loadPanel(){return null===n.container?$.ajax({type:'POST',url:tbBuilderPage.ajaxurl,data:{_ajax_nonce:tbBuilderPage.nonce,action:'tb_builder_page'},success(e){let t=u.createElement('div');t.innerHTML=e,n.container=t.firstChild,n.layout_lists=n.container.getElementsByClassName('tbbp_layout_lists')[0],u.body.appendChild(n.container)}}):new Promise(e=>{e()})},showPanel(){n.container.style.display='block'},hidePanel(){n.container.style.display='none'},run(){(n=this).loadCSS(),n.loadPanel().then(function(){n.showPanel(),n.layouts_loaded||n.loadLayoutsList(),n.init(),n.container.querySelector('#title').focus()})}}})(jQuery,document);